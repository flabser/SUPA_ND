"use strict";var nb={APP_NAME:location.hostname,LANG_ID:"RUS",debug:!0,strings:{yes:"Да",no:"Нет",ok:"Ok",cancel:"Отмена",select:"Выбрать",dialog_select_value:"Вы не сделали выбор"},form:{},dialog:{},utils:{},xhr:{}},nbApp={};nb.ajax=function(e){var t=$.ajax(e);return t.error(function(e){return console.error("nb.ajax : error",e),400==e.status&&nb.dialog.error({title:nb.getText("error_xhr","Ошибка запроса"),message:e.responseText}),e}),t},nb.getText=function(e,t,n){return nbStrings[n||this.LANG_ID][e]?nbStrings[n||this.LANG_ID][e]:void 0!==t?t:e},nb.openXML=function(){window.location.href=window.location+"&onlyxml"},nb.form.setValues=function(e){function t(){if(l){$("[name="+r+"]",i).remove();var e=[];n.each(function(t,n){$('<input type="hidden" name="'+r+'" value="'+n.value+'" />').appendTo(i),e.push("<li>"+$(n).data("text")+"</li>")}),$("[data-input="+r+"]").html(e.join(""))}else{var t=$("[name="+r+"]",i);0===t.length&&(t=$('<input type="hidden" name="'+r+'" />'),$(i).append(t[0])),t.val(n[0].value),$("[data-input="+r+"]").html("<li>"+n.attr("data-text")+"</li>")}return!0}var n,o=$(e).parents("[role=dialog]"),a=$("[data-role=nb-dialog]",o),i=nb.utils.getForm(a[0].dialogOptions.targetForm),r=a[0].dialogOptions.fieldName,l=!1,s="";return i?(n=$("[data-type=select]:checked",a[0]),n.length>0?(l=n.length>1,l||(s=""),t(n)):(a[0].dialogOptions.effect&&(o.stop(),o.effect(a[0].dialogOptions.effect,{times:2},300)),0===$(".js-no-selected-value",o[0]).length&&!function(){var e=$('<div class="alert alert-danger js-no-selected-value" style="border-radius:2px;top:50%;left:4%;right:4%;position:absolute;">'+a[0].dialogOptions.errorMessage+"</div>");a.after(e),setTimeout(function(){e.fadeOut({always:function(){e.remove()}})},800)}(),!1)):(nb.dialog.warn({title:"Error",message:"Error nb.form.setValues > form is not found: "+i}),!1)},nb.utils.clearField=function(e,t){$("[name="+e+"]").val(""),$("[data-input="+e+"]").html("")},nb.utils.getForm=function(e){return null===e||void 0===e?e:"string"==typeof e&&document[e]&&"FORM"===document[e].nodeName?document[e]:e.form||e},nb.utils.blockUI=function(){var e=$("#nb-block-ui");0===e.length&&(e=$('<div id="nb-block-ui" style="background:rgba(0,0,0,0.1);position:fixed;top:0;left:0;bottom:0;right:0;z-index:999;"/>'),e.appendTo("body")),e.css("display","block")},nb.utils.unblockUI=function(){$("#nb-block-ui").css("display","none")},nb.utils.notify=function(e){var t=$("#nb-notify-wrapper");t.length||(t=$("<div id=nb-notify-wrapper class=nb-notify></div>").appendTo("body"));var n=$("<div class=nb-notify-entry-"+(e.type||"info")+">"+e.message+"</div>").appendTo(t);return{show:function(e){return n.css("display","block"),e&&e>0?void this.remove(e):this},hide:function(){return n.css("display","none"),this},set:function(e){for(var t in e)"text"===t?n.text(e[t]):"type"===t&&n.attr("class","nb-notify-entry-"+e[t]);return this},remove:function(e,t){if(null!==n)if(e&&e>0){setTimeout(function(){n.remove(),n=null,t&&t()},e)}else n.remove(),n=null,t&&t()}}},$(document).ready(function(){nb.LANG_ID=$.cookie("lang")||"RUS",$(":checkbox").bind("click",function(){var e=$(this);if(!e.data("toggle"))return!0;var t=this.name||e.data("toggle"),n=$("[name="+t+"]:checkbox:visible");e.is(":checked")?n.each(function(){this.checked=!0}):n.each(function(){this.checked=!1})})}),nb.dialog={_props:{title:nb.APP_NAME},info:function(e){return e.className="dialog-info",e.width=e.width||"360",e.height=e.height||"210",e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},warn:function(e){return e.className="dialog-warn",e.width=e.width||"360",e.height=e.height||"210",e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},error:function(e){return e.className="dialog-error",e.width=e.width||"360",e.height=e.height||"210",e.buttons=e.buttons||{Ok:function(){$(this).dialog("close")}},this.show(e)},execute:function(e){var t=$(e).parents("[role=dialog]"),n=$("[data-role=nb-dialog]",t);n[0].dialogOptions.onExecute(arguments)},show:function(e){var t;if(e.id=e.id||null,e.title=e.title||this._props.title,e.href=e.href||null,e.className=e.className||"",e.message=e.message||null,e.filter=e.filter,e.dialogFilterListItem=e.dialogFilterListItem||"li",e.buttons=e.buttons||null,e.dialogClass="nb-dialog "+(e.dialogClass?e.dialogClass:""),e.errorMessage=e.errorMessage||nb.strings.dialog_select_value,e.onLoad=e.onLoad||null,e.onExecute=e.onExecute||function(){nb.form.setValues(t,null)&&t.dialog("close")},e.autoOpen=!0,e.modal===!1?e.modal=!1:e.modal=!0,e.width=e.width||"360",e.position=e.position||"center",e.resizable=e.resizable||!1,e.draggable=e.draggable||!1,null===e.id&&e.href){if(e.id="dlg_"+e.href.replace(/[^a-z0-9]/gi,""),t=$("#"+e.id),t[0])return t.dialog("isOpen")===!0?void 0:void t.dialog("open")}else if(null!==e.id&&(t=$("#"+e.id),t[0]))return t.dialog("isOpen")===!0?void 0:void t.dialog("open");null===e.id&&(e.close=e.close||function(){t.dialog("destroy"),t.remove()});var n;return n=e.href?$('<div data-role="nb-dialog" id="'+e.id+'" class="nb-dialog-container '+e.className+'"><div class="loading-state"></div></div>'):e.id?$('<div data-role="nb-dialog" id="'+e.id+'" class="nb-dialog-container '+e.className+'">'+e.message+"</div>"):$('<div data-role="nb-dialog" class="nb-dialog-container '+e.className+'">'+e.message+"</div>"),e.href?(t=n.load(e.href,"",function(t,o,a){if("error"===o)n.html('<div class="alert alert-danger">'+o+"</div>"),nb.debug===!0&&console.log("nb.dialog : load callback",a);else{try{null!==e.onLoad&&e.onLoad(t,o,a)}catch(i){console.log("nb.dialog",i)}try{e.filter!==!1&&new nb.dialog.Filter(n,e.dialogFilterListItem,13)}catch(i){console.log("nb.dialog",i)}}}).dialog(e),t.on("click","a",function(e){e.preventDefault(),n.load(this.href)}),t.on("change","select",function(e){e.preventDefault(),n.load(this.href)})):t=n.dialog(e),t[0].dialogOptions=e,nb.debug===!0&&console.log("nb.dialog: ",e),t}},nb.dialog.Filter=function(e,t,n,o){function a(){r=$(p,h[0]);var e=$(".toggle-response",h[0]).length>0;r.length<s&&!e||(0===$(".dialog-filter",g).length&&h.before("<div class=dialog-filter></div>"),$(".dialog-filter",g).append('<input type=text name=keyword data-role=search placeholder="'+nb.getText("filter","Фильтр")+'" />'),l=$(".dialog-filter input[data-role=search]",g),l.on("keyup",function(e){try{if(clearTimeout(u),13===e.keyCode)return}catch(t){console.log(t)}u=setTimeout(function(){r=$(p,h[0]),i(e.target.value)},d)}))}function i(e){try{if(e.length>=c){var t=0,n=new RegExp(e,"gim");r.attr("style",""),r.each(function(o,a){n.test(a.textContent)||-1!=a.textContent.indexOf(e)||0===$(":checked",a).length&&(a.style.display="none",t++)}),r.length>t?l.attr("title","By keyword ["+e+"] filtered "+(r.length-t)):l.attr("title",nb.getText("filter_no_results","Не найдено"))}else r.attr("style",""),l.attr("title","")}catch(o){console.log(o)}}var r,l=null,s=n||13,c=o||2,d=300,u=null,p=t||".item",h=e,g=h.parents("[role=dialog]");a()},nb.windowOpen=function(e,t,n){var o,a=800,i=600,r=(window.innerHeight-i)/2,l=(window.innerWidth-a)/2;0>r&&(r=0),0>l&&(l=0),o="top="+r+",left="+l,o+=",height="+i+",width="+a+",resizable=yes,scrollbars=yes,status=no";var s="window-"+(t||e.hashCode()),c=window.open("",s,o);if(("about:blank"===c.document.URL||""===c.document.URL)&&(c=window.open(e,s,o),n&&n.onclose))var d=setInterval(function(){c.closed&&(clearInterval(d),n.onclose())},1e3);c.focus()},nb.xhr.deleteDocument=function(e,t){return nb.debug===!0&&console.log("nb.xhr.deleteDocument: ",e,t),nb.ajax({type:"POST",datatype:"XML",url:"Provider",data:{type:"delete",ck:e,typedel:t}})},nb.xhr.restoreDeletedDocument=function(e){return nb.debug===!0&&console.log("nb.xhr.restoreDeletedDocument: ",e),nb.ajax({type:"POST",datatype:"XML",url:"Provider",data:{type:"undelete",ck:e}})},nb.xhr.addDocumentToFavorite=function(e,t){return nb.debug===!0&&console.log("nb.xhr.addDocumentToFavorite: ",e,t),nb.ajax({type:"POST",datatype:"XML",url:"Provider",data:{type:"service",operation:"add_to_favourites",doctype:t,key:e}})},nb.xhr.removeDocumentFromFavorite=function(e,t){return nb.debug===!0&&console.log("nb.xhr.removeDocumentFromFavorite: ",e,t),nb.ajax({type:"POST",datatype:"XML",url:"Provider",data:{type:"service",operation:"remove_from_favourites",doctype:t,key:e}})},nb.xhr.markDocumentAsRead=function(e,t){return nb.debug===!0&&console.log("nb.xhr.markDocumentAsRead: ",e,t),nb.ajax({type:"POST",datatype:"XML",url:"Provider",data:{type:"service",operation:"mark_as_read",id:"mark_as_read",doctype:t,key:e}})},nb.xhr.getUsersWichRead=function(e,t){return nb.debug===!0&&console.log("nb.xhr.getUsersWichRead: ",e,t),nb.ajax({type:"GET",datatype:"XML",url:"Provider",data:{type:"service",operation:"users_which_read",id:"users_which_read",doctype:t,key:e}})},nb.xhr.saveDocument=function(e){e=e||{};var t=nb.utils.notify({message:nb.getText("wait_while_document_save","Пожалуйста ждите... идет сохранение документа"),type:"process"}).show(),n={cache:!1,type:"POST",datatype:"XML",url:"Provider",data:e.data||$("form").serialize(),beforeSend:function(){nb.utils.blockUI(),$(".required, [required]","form").removeClass("required").removeAttr("required")},success:function(n){var o=nb.utils.parseMessageToJson(n),a=o.message[0];if("ok"===o.status)t.set({text:nb.getText("document_saved","Документ сохранен"),type:"success"}),a.length>0?nb.dialog.info({message:a,close:function(){(o.redirect||e.redirect)&&(window.location.href=o.redirect||e.redirect)}}):(o.redirect||e.redirect)&&setTimeout(function(){window.location.href=o.redirect||e.redirect},300);else if(0===a.indexOf("require:")){var r=a.substr("require:".length).split(",");for(i=0;i<r.length;i++)$("#"+r[i]+"tbl").addClass("required"),$("[name="+r[i]+"]").attr("required","required").addClass("required");t.set({text:nb.getText("required_field_not_filled","Не заполнены обязательные поля"),type:"error"})}else t.set({text:a,type:"error"})},error:function(){t.set({text:nb.getText("error_xhr","Ошибка при выполнении запроса"),type:"error"})}},o=nb.ajax(n);return o.always(function(){nb.utils.unblockUI(),t.remove(2e3)}),o},nb.utils.parseMessageToJson=function(e){var t={};return $(e).find("response").each(function(e){t.status=$(this).attr("status"),t.redirect=$("redirect",this).text(),t.message=[],$(this).find("message").each(function(e){t.message.push($(this).text())})}),t},nb.xhr.chooseFilter=function(e,t,n){return nb.debug===!0&&console.log("nb.xhr.chooseFilter: ",e,t,n),nb.ajax({type:"GET",datatype:"XML",url:"Provider?param=filter_mode~on&param=filtered_column~"+t+"&param=key_word~"+n,cache:!1,data:{type:"service",operation:"tune_session",element:"page",id:e}})},nb.xhr.resetFilter=function(e){return nb.debug===!0&&console.log("nb.xhr.resetFilter: ",e),nb.ajax({type:"POST",datatype:"XML",url:"Provider",cache:!1,data:{type:"service",operation:"tune_session",element:"page",id:e,param:"filter_mode~reset_all"}})},nb.xhr.resetCurrentFilter=function(e,t){return nb.debug===!0&&console.log("nb.xhr.resetCurrentFilter: ",e,t),nb.ajax({type:"GET",datatype:"XML",url:"Provider?param=filter_mode~on&param=filtered_column~"+t,cache:!1,data:{type:"service",operation:"tune_session",element:"page",id:e}})};var nbStrings={RUS:{},KAZ:{},ENG:{},CHN:{}};nbStrings.RUS={yes:"Да",no:"Нет",ok:"Ok",cancel:"Отмена",select:"Выбрать",dialog_select_value:"Вы не сделали выбор"},nb.xhr.sendSortRequest=function(e,t,n){return nb.debug===!0&&console.log("nb.xhr.sendSortRequest: ",e,t,n),nb.ajax({type:"POST",datatype:"XML",url:"Provider?param=sorting_mode~on&param=sorting_column~"+t.toLowerCase()+"&param=sorting_direction~"+n.toLowerCase(),data:{type:"service",operation:"tune_session",element:"page",id:e}})},$(function(){$("[data-action=save_and_close]").click(function(){SaveFormJquery()}),$("[data-role=side-tree-toggle]").click(function(){$(this).parent().toggleClass("side-tree-collapse")}),$(window).resize(function(){window.innerWidth<=800?$("body").addClass("phone"):$("body").removeClass("phone")}),window.innerWidth<=800&&$("body").addClass("phone");try{var e=$.cookie("lang")||"RUS";$("input[type=date]").datepicker({dateFormat:"yy-mm-dd",showOn:"button",buttonImage:"/SharedResources/img/iconset/calendar.png",buttonImageOnly:!0,regional:["ru"],showAnim:"",monthNames:calendarStrings[e].monthNames,monthNamesShort:calendarStrings[e].monthNamesShort,dayNames:calendarStrings[e].dayNames,dayNamesShort:calendarStrings[e].dayNamesShort,dayNamesMin:calendarStrings[e].dayNamesMin,weekHeader:calendarStrings[e].weekHeader,yearSuffix:calendarStrings[e].yearSuffix})}catch(t){console.log(t)}});var app=app||{};app.proposal={init:function(){nbStrings.RUS.action_coord_start="Отправлено на согласование",nbStrings.RUS.action_coord_agree="Согласен",nbStrings.RUS.action_coord_revision="Возврат на доработку",nbStrings.RUS.action_coord_reject="На исключение"},actions:{save:function(e,t){$("[name=_action]").val(t);var n=$("form[name=proposal]")[0],o=$(n).serialize();nb.utils.blockUI();var a;return t&&(a=nb.utils.notify({message:nb.getText("action_"+t)}).show()),$.ajax({method:"POST",datatype:"html",url:"Provider",data:o,success:function(e){return nb.utils.unblockUI(),a&&a.remove(3e3),nb.utils.notify({message:nb.getText("saved","Сохранен")}).show(2e3),$("[data-action=close]")[0].click(),e}})},coordStart:function(e){return this.save(e,"coord_start")},coordAgree:function(e){return this.save(e,"coord_agree")},coordRevision:function(e){return this.save(e,"coord_revision")},coordReject:function(e){return this.save(e,"coord_reject")},dialogSelectDueDateLink:function(){var e=nb.dialog.show({title:"selectDueDateLink",href:"Provider?type=page&id=proposals-list",buttons:{cancel:{text:nb.getText("cancel"),click:function(){e.dialog("close")}},select:{text:nb.getText("select"),click:function(){}}}})},dialogSelectAssignees:function(e,t,n){var o=$("form[name=proposal]"),a=nb.dialog.show({targetForm:o,fieldName:t,dialogFilterListItem:"li",title:e.title,href:"Provider?type=view&id=dialog-structure&page=1&fieldName="+t+"&isMulti="+n,onLoad:function(){n===!1&&$("[type=checkbox][data-type=select]",a[0]).attr("type","radio")},buttons:{cancel:{text:nb.getText("cancel"),click:function(){a.dialog("close")}},select:{text:nb.getText("select"),click:function(){a[0].dialogOptions.onExecute()}}}})}}},$(function(){app.proposal.init(),$("[data-action=save]").click(function(){app.proposal.actions.save(this)}),$("[data-action=coord_start]").click(function(){var e=this,t=nb.dialog.show({title:e.title,message:nb.getText("send_to_coordination","Отправить на согласование?"),buttons:{cancel:{text:nb.getText("cancel"),click:function(){t.dialog("close")}},reject:{text:nb.getText("send","Отправить"),click:function(){t.dialog("close"),app.proposal.actions.coordStart(e)}}}})}),$("[data-action=coord_agree]").click(function(){var e=this,t=nb.dialog.show({title:e.title,message:nb.getText("confirm_action","Подтвердите действие")+' "'+nb.getText("agree","Отправить")+'"',buttons:{cancel:{text:nb.getText("cancel"),click:function(){t.dialog("close")}},reject:{text:nb.getText("agree","Отправить"),click:function(){t.dialog("close"),app.proposal.actions.coordAgree(this)}}}})}),$("[data-action=coord_revision]").click(function(){var e=this,t="<h4>Отправить на доработку?</h4><div>Комментарий</div><textarea></textarea>",n=nb.dialog.show({title:e.title,message:t,buttons:{cancel:{text:nb.getText("cancel"),click:function(){n.dialog("close")}},revision:{text:"Отправить",click:function(){var t=n.find("textarea").val();if(t){n.dialog("close");var o=$("form[name=proposal]")[0];o.coordination_comment.value=t,app.proposal.actions.coordRevision(e)}}}}})}),$("[data-action=coord_reject]").click(function(){var e=this,t=nb.dialog.show({title:e.title,message:nb.getText("confirm_action","Подтвердите действие")+' "'+nb.getText("coord_reject","Исключить")+'"',buttons:{cancel:{text:nb.getText("cancel"),click:function(){t.dialog("close")}},reject:{text:nb.getText("coord_reject","Исключить"),click:function(){t.dialog("close"),app.proposal.actions.coordReject(this)}}}})}),$("[data-action=select-assignees]").click(function(){app.proposal.actions.dialogSelectAssignees(this,"assignee",!1)}),$("[data-action=due-date-link]").click(function(){app.proposal.actions.dialogSelectDueDateLink()});var e=$("[name=ddbid]").val();e&&$("#history").load("Provider?type=page&id=proposal-events&proposal_id="+e)}),window.app=window.app||{},app.DueDate=function(e){this.$el=e.el,this.$dueDateType=e.dueDateType,this.$dueDate=e.dueDate,this.$dueDatePlanId=e.dueDatePlanId,this.type=this.$dueDateType.value||"month";var t=[(new Date).getFullYear(),(new Date).getMonth()];"plan-doc"!==this.type&&this.$dueDate.value&&(t=this.$dueDate.value.split("-")),this.year=+t[0],this.part=+t[1],this.monthCount=1;var n=this;$("body").on("click",function(){$(".due-date.open").removeClass("open")}),$(this.$el).on("click",function(e){e.stopPropagation()}),$(".due-date-text",this.$el).on("click",function(){$(n.$el).toggleClass("open")}),$(".due-date-type",this.$el).on("change",function(){n.type=this.value,n.part=1,n.render()}),$(".btn-apply",this.$el).click(function(){n.apply()}),$(".btn-cancel",this.$el).click(function(){n.cancel()}),this.render(),this.renderText()},app.DueDate.prototype.types={month:12,quarter:4,"half-year":2,"plan-doc":0},app.DueDate.prototype.monthNames=["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],app.DueDate.prototype.plusMonth=function(){this.monthCount++,this.render()},app.DueDate.prototype.minusMonth=function(){this.monthCount--,this.render()},app.DueDate.prototype.apply=function(){this.write(),$(this.$el).toggleClass("open")},app.DueDate.prototype.cancel=function(){$(this.$el).toggleClass("open")},app.DueDate.prototype.write=function(){switch(this.type){case"month":case"quarter":case"half-year":this.$dueDate.value=this.year+"-"+this.part;break;case"plan-doc":this.$dueDate.value=""}this.$dueDateType.value=this.type,this.renderText()},app.DueDate.prototype.renderText=function(){var e=this.$el.querySelector(".due-date-text");switch(this.type){case"month":e.innerHTML=this.type+":"+this.year+"-"+this.monthNames[this.part-1];break;case"quarter":e.innerHTML=this.part+" квартал "+this.year+"г.";break;case"half-year":e.innerHTML=this.part+" полугодие "+this.year+"г.";break;case"plan-doc":e.innerHTML="plan-doc"}},app.DueDate.prototype.render=function(){var e=this,t=this.$el.querySelector(".due-date-part"),n=document.createDocumentFragment();switch(this.type){case"month":for(var o,a=1;a<=this.monthCount;a++){o=document.createElement("li");var i=document.createElement("input");i.type="number",i.min=(new Date).getFullYear(),i.max=(new Date).getFullYear()+5,i.value=this.year,i.onblur=function(){e.year=this.value},i.onchange=function(){e.year=this.value},o.appendChild(i);for(var r=document.createElement("select"),l=1;l<=this.types[this.type];l++){var s=document.createElement("option");s.value=l,s.textContent=l+") "+this.monthNames[l-1],r.appendChild(s)}r.onchange=function(){e.part=this.value},r.value=a,o.appendChild(r),n.appendChild(o)}o=document.createElement("li");var c=document.createElement("button");c.className="btn btn-sm",c.type="button",c.innerHTML="+",c.onclick=function(){e.plusMonth()},o.appendChild(c),n.appendChild(o);break;case"quarter":case"half-year":var o=document.createElement("li"),i=document.createElement("input");i.type="number",i.min=(new Date).getFullYear(),i.max=(new Date).getFullYear()+5,i.value=this.year,i.onblur=function(){e.year=this.value},i.onchange=function(){e.year=this.value},o.appendChild(i);for(var r=document.createElement("select"),l=1;l<=this.types[this.type];l++){var s=document.createElement("option");s.value=l,s.textContent=l,r.appendChild(s)}r.onchange=function(){e.part=this.value},r.value=this.part,o.appendChild(r),n.appendChild(o);break;case"plan-doc":}this.$el.querySelector(".due-date-type").value=this.type,t.innerHTML="",t.appendChild(n)};